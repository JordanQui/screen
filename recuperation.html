<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Patch Hydra — 11 sept (visual only) — fixed</title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden}
  canvas{position:fixed;inset:0;width:100vw;height:100vh;display:block;background:#000}
  #hud{position:fixed;left:10px;bottom:10px;color:#0f0;background:#0008;padding:6px 8px;border-radius:6px;font:12px ui-monospace,Menlo,Consolas,monospace;pointer-events:none;white-space:pre}
</style>
<script src="https://cdn.jsdelivr.net/npm/hydra-synth/dist/hydra-synth.js"></script>
</head>
<body>
<canvas id="hydra"></canvas>
<pre id="hud">waiting bands…</pre>

<script>
/* Visual-only patch (reconstruction 11 sept), fixed: no .blur() calls.
   Expects postMessage({ type:'bands', low, mid1, mid2, high }) from the shell.
*/

const hud = document.getElementById('hud');

/* receive bands from shell */
let bands = { low:0, mid1:0, mid2:0, high:0 };
window.addEventListener('message', (e) => {
  const d = e.data;
  if (!d || d.type !== 'bands') return;
  bands.low  = Number.isFinite(d.low ) ? d.low  : 0;
  bands.mid1 = Number.isFinite(d.mid1) ? d.mid1 : 0;
  bands.mid2 = Number.isFinite(d.mid2) ? d.mid2 : 0;
  bands.high = Number.isFinite(d.high) ? d.high : 0;
});

/* Hydra init */
const canvas = document.getElementById('hydra');
const h = new Hydra({ canvas: canvas, detectAudio:false, enableStreamCapture:false });

/* Hi-DPI fit */
function fit(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width  = Math.floor(innerWidth * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  canvas.style.width  = innerWidth + 'px';
  canvas.style.height = innerHeight + 'px';
}
fit(); addEventListener('resize', fit);

/* smoothing */
let sLow=0, sM1=0, sM2=0, sH=0;
const SMOOTH = 0.12;
function smoothBands(){
  sLow += (bands.low  - sLow)  * SMOOTH;
  sM1  += (bands.mid1 - sM1)   * SMOOTH;
  sM2  += (bands.mid2 - sM2)   * SMOOTH;
  sH   += (bands.high - sH)    * SMOOTH;
}

/* Small helper: softening operator (no .blur): use noise modulation + slight scaling + luma/contrast */
function softify(src, intensity){
  // intensity: 0..1 (higher -> stronger soft)
  return src
    .modulate(noise(()=> 0.08 * (0.2 + intensity)), ()=> 0.08 * (0.5 + intensity*0.8))
    .scale(()=> 1 + 0.002 * (0.5 + intensity))
    .luma()
    .contrast(()=> 1.0 + intensity*0.3);
}

/* Build the visual (single-time build) */
function buildPatch(){
  // background magenta (keeps low visible in idle)
  const bg = solid(0.92, 0.05, 0.50)
    .brightness(()=> 0.98 + sLow*0.02)
    .saturate(()=> 0.9 + sM2*0.06);

  // three detuned oscillators create the central undulating band
  const o1_base = osc(()=> 0.6 + sLow*6.0, ()=> 8 + sM1*36, 0)
            .rotate(()=> Math.sin(time*0.02)*0.02)
            .color(()=> 0.06, ()=> 0.14 + sM2*0.28, ()=> 0.7 + sM2*0.18)
            .contrast(()=> 1.0 + sM2*0.6);

  const o2_base = osc(()=> 1.2 + sLow*4.0, ()=> 10 + sM1*32, 0)
            .modulate(noise(()=> 0.15 + sM2*0.5), ()=> 0.2 + sM1*0.6)
            .color(()=> 0.03, ()=> 0.08 + sM2*0.22, ()=> 0.62 + sM2*0.25)
            .contrast(()=> 1.0 + sM2*0.5);

  const o3_base = osc(()=> 2.4 + sLow*3.0, ()=> 6 + sM2*20, 0)
            .modulate(o1_base, ()=> 0.12 + sM2*0.5)
            .color(()=> 0.04, ()=> 0.07 + sM2*0.18, ()=> 0.5 + sM2*0.2)
            .contrast(()=> 1.0 + sM2*0.4);

  // apply softify with different intensities instead of blur
  const o1 = softify(o1_base, ()=> 0.6 + sM1*0.3);
  const o2 = softify(o2_base, ()=> 0.75 + sM2*0.25);
  const o3 = softify(o3_base, ()=> 0.45 + sM2*0.2);

  // composite "band" with darker belly (use multiply/add and luma to get depth)
  const band = o1.mult(o2).add(o3)
    .brightness(()=> -0.12 - sLow*0.25)
    .contrast(()=> 1.0 + sH*0.35)
    .saturate(()=> 0.6 + sM2*0.3)
    .mask(shape(4).scale(2.2,0.6).translate(0,0).smooth(0.5))
    // extra gentle soft overlay to replace final blur
    .blend(noise(()=> 0.02 + (1 - sM1) * 0.04).scale(3), ()=> 0.02 + (1 - sM1)*0.12);

  // low warm glow (idle visible)
  const lowGlowBase = osc(0.2, ()=> 12 + sLow*60, 0)
    .color(()=> 0.9, ()=> 0.18, ()=> 0.12)
    .brightness(()=> 0.06 + sLow*0.3);

  const lowGlow = softify(lowGlowBase, ()=> 0.9 + sLow*0.4)
    .blend(solid(0.02,0.01,0.05), ()=> 0.2 + sLow*0.5);

  // final composition (bg + band + lowGlow)
  bg
    .blend(band, ()=> 0.85 + sM1*0.15)
    .blend(lowGlow, ()=> 0.12 + sLow*0.6)
    .saturate(0.95)
    .contrast(1.04)
    .out(o0);

  render(o0);
}

buildPatch();

/* small ready ping to parent shell (paint-hot) */
try { parent.postMessage({ type:'paint-hot' }, '*'); } catch(e){}

/* main loop: smooth bands and update HUD */
function frame(){
  smoothBands();
  hud.textContent = `low:${sLow.toFixed(3)} mid1:${sM1.toFixed(3)} mid2:${sM2.toFixed(3)} high:${sH.toFixed(3)}`;
  requestAnimationFrame(frame);
}
frame();

</script>
</body>
</html>
