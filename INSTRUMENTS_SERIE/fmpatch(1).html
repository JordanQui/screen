<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Hydra • FM String — 5 ops (safe & flat) • params exposés</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    canvas { position:fixed; inset:0; width:100vw; height:100vh; display:block; background:#000; }
    #hud{position:fixed;left:8px;bottom:8px;color:#0f0;background:#000a;padding:6px 8px;border-radius:6px;
         font:12px ui-monospace,Menlo,Consolas,monospace;pointer-events:none;white-space:pre}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hydra-synth/dist/hydra-synth.js"></script>
</head>
<body>
<canvas id="hydra"></canvas>
<!-- <div id="hud"></div> -->
<script>
/* ====== Bands in (depuis le shell) ====== */
let low=0, mid1=0, mid2=0, high=0;
addEventListener('message',(e)=>{
  const d=e.data; if(!d) return;
  if(d.type==='bands'){ low=d.low||0; mid1=d.mid1||0; mid2=d.mid2||0; high=d.high||0; }
});

/* ====== Params exposés ======
   Tweake-les en live: ex. P.idx.C1_M1 = 0.28
*/
window.P = {
  // Index de modulation (gains “FM” de base)
  idx: {
    C1_M1: 0.20,   // M1 -> C1
    C1_M2: 0.10,   // M2 -> C1
    C3_M1: 0.12,   // M1 -> C3
    C4_M2: 0.12,   // M2 -> C4
    C4_NO: 0.05,   // noise -> C4 (grain aigus)
    C5_M1: 0.10,   // M1 -> C5 (sub sympathetic)
    C5_M2: 0.10    // M2 -> C5
  },
  // Poids des couches dans le mix final
  mix: {
    C2: 0.95,
    C3: 0.95,
    C4: 0.90,
    C5: 0.85,
    pluck: 0.30
  },
  // Masque "corde"
  maskY: 0.06,     // épaisseur verticale (plus petit = plus fin)
  // Color finishing
  sat: 1.02,
  ctr: 1.012,
  // Flow anti-pixel
  flowBase: 0.008, flowL: 0.014, flowH: 0.022,
  // Feedback (propre)
  fbMax: 0.34, fbBase: 0.12, fbL: 0.18, fbH: 0.14
};

/* ====== Hi-DPI + Hydra ====== */
const canvas = document.getElementById('hydra');
function setHiRes(){
  const dpr = Math.min(3.0, window.devicePixelRatio||1);
  const w = Math.floor(innerWidth*dpr), h = Math.floor(innerHeight*dpr);
  canvas.width=w; canvas.height=h;
  if (window.hydra?.setResolution) window.hydra.setResolution(w,h);
}
setHiRes();
const hydra = new Hydra({ canvas, detectAudio:false, width:canvas.width, height:canvas.height, pixelRatio:1 });
window.hydra = hydra;
addEventListener('resize', setHiRes);

/* ====== Aliases ====== */
const L  = () => low;
const M1 = () => mid1;
const M2 = () => mid2;
const Hh = () => high;
const Hs = () => Math.pow(Hh(), 0.72); // aigus adoucis

/* ====== Fréquences (douces, proches du boiler) ====== */
const fLow  = () =>  8.0 + L()*20 + (L()*2.0)*Math.sin(time*1.11);
const fM1   = () => 10.5 + M1()* 8 + (M1()*1.7)*Math.sin(time*1.33);
const fM2   = () => 14.0 + M2()*10 + (M2()*2.0)*Math.sin(time*1.55);
const fHigh = () => Math.min(18 + Hs()*28 + (Hs()*2.4)*Math.sin(time*2.30), 34);
const fC5   = () => Math.max(5.5, fLow()*0.72 + (L()*1.6 + (M1()+M2())*0.8)*0.5);

/* ====== Indices FM dépendant des bandes (M1/M2/H) ====== */
const I_C1_M1 = () => 0.020 + M1()*P.idx.C1_M1;
const I_C1_M2 = () => 0.010 + M2()*P.idx.C1_M2;
const I_C3_M1 = () => 0.010 + M1()*P.idx.C3_M1;
const I_C4_M2 = () => 0.010 + M2()*P.idx.C4_M2;
const I_C4_NO = () => 0.006 + Hs()*P.idx.C4_NO;
const I_C5_M1 = () => 0.008 + M1()*P.idx.C5_M1;
const I_C5_M2 = () => 0.008 + M2()*P.idx.C5_M2;

/* ====== Masque "corde" ====== */
function stringMask(){
  return shape(4, 0.5, 0.001).scale(2.0, Math.max(0.01, P.maskY));
}

/* ====== Patch FLAT (une passe + post + feedback) ====== */
function buildPatch(){
  const m1 = osc(fM1, 0, 0);
  const m2 = osc(fM2, 0, 0);
  const mask = stringMask();

  const C1 = osc(fLow, 0, 0)
    .modulate(m1, I_C1_M1)
    .modulate(m2, I_C1_M2)
    .mult(mask)
    .color(() => 0.12 + L()*0.88, 0, 0);

  const C2 = osc(fM1, 0, 0)
    .mult(mask)
    .color(0, () => 0.18 + M1()*0.82, 0);

  const C3 = osc(fM2, 0, 0)
    .modulate(m1, I_C3_M1)
    .mult(mask)
    .color(0, 0, () => 0.18 + M2()*0.82);

  const C4 = osc(fHigh, 0, 0)
    .modulate(m2, I_C4_M2)
    .modulate(noise(2.3, 0.22), I_C4_NO)
    .mult(mask)
    .color(
      () => 0.08 + Math.min(1.00, Hs()*1.05),
      () => 0.08 + Math.min(1.00, Hs()*1.05),
      () => 0.08 + Math.min(1.00, Hs()*1.05)
    );

  const C5 = osc(fC5, 0, 0)
    .modulate(m1, I_C5_M1)
    .modulate(m2, I_C5_M2)
    .mult(mask)
    .color(() => 0.08 + L()*0.70, 0, 0);

  // Pluck léger (inline)
  const strike = osc(4, 0.20, 0.001)
    .scale(0.4, 1.0)
    .scrollX(() => Math.sin(time*0.18)*0.30 + (M2()-L())*0.10);

  const pluck = noise(
      () => 1.1 + Hs()*6.0,
      () => 0.10 + Hs()*0.40
    )
    .thresh(() => 0.72 - Math.min(0.6, Hs()*0.52))
    .luma(() => 0.50 + (1.0 - Hs())*0.25)
    .brightness(() => 0.06 + Hs()*0.55)
    .contrast(1.04)
    .color(
      () => 0.35 + Hs()*0.60,
      () => 0.35 + Hs()*0.60,
      () => 0.35 + Hs()*0.60
    )
    .mult(strike)
    .modulate(osc(3.0, 0, 0), () => 0.02 + Hs()*0.05);

  // Somme (paramétrable)
  let comp = C1
    .add(C2, P.mix.C2)
    .add(C3, P.mix.C3)
    .add(C4, P.mix.C4)
    .add(C5, P.mix.C5)
    .add(pluck, P.mix.pluck)
    .saturate(P.sat)
    .contrast(P.ctr);

  // Flow anti-pixel
  const flow = noise(
    () => 1.22 + (M1()+M2()+Hh())*1.9,
    () => 0.05  + Hh()*0.36
  );
  comp = comp.modulate(flow, () => P.flowBase + (L()+M1()+M2())*P.flowL + Hs()*P.flowH);

  // Feedback propre (image précédente de o0)
  const fbAmt = () => Math.min(P.fbMax, P.fbBase + (L()+M1()+M2())*P.fbL + Hs()*P.fbH);
  comp.blend(
    src(o0).colorama(() => 0.008 + Hh()*0.032).contrast(1.001),
    fbAmt
  ).out(o0);
}
buildPatch();
render(o0);

/* ====== Mini HUD (affiche quelques params utiles) ====== */
// const hud = document.getElementById('hud');
// function drawHUD(){
//   hud.textContent =
// `FM idx: C1_M1=${P.idx.C1_M1.toFixed(2)}  C1_M2=${P.idx.C1_M2.toFixed(2)}
//          C3_M1=${P.idx.C3_M1.toFixed(2)}  C4_M2=${P.idx.C4_M2.toFixed(2)}  C4_NO=${P.idx.C4_NO.toFixed(2)}
//          C5_M1=${P.idx.C5_M1.toFixed(2)}  C5_M2=${P.idx.C5_M2.toFixed(2)}
// Mix:     C2=${P.mix.C2.toFixed(2)}  C3=${P.mix.C3.toFixed(2)}  C4=${P.mix.C4.toFixed(2)}  C5=${P.mix.C5.toFixed(2)}  pluck=${P.mix.pluck.toFixed(2)}
// MaskY=${P.maskY.toFixed(3)}  sat=${P.sat.toFixed(3)}  ctr=${P.ctr.toFixed(3)}  fbMax=${P.fbMax.toFixed(2)}`;
//   requestAnimationFrame(drawHUD);
// }
// drawHUD();

/* ====== Ping orchestrateur ====== */
requestAnimationFrame(()=> parent.postMessage({type:'paint-hot'}, '*'));
</script>
</body>
</html>
